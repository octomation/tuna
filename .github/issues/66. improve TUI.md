---
issue: 66
status: open
type: task
labels:
  - "effort: medium"
  - "impact: high"
  - "scope: code"
  - "scope: deps"
  - "type: improvement"
assignees:
  - kamilsk
milestone: null
projects: []
relationships:
  parent: null
  blocked_by: []
  blocks: []
---

# Implement interactive TUI using Charm libraries

## Summary

Replace plain text output in all CLI commands with interactive TUI components built on Charm libraries. This will provide consistent visual feedback, progress tracking, and improved UX.

## Current state

All commands (`init`, `plan`, `exec`) use basic `cmd.Printf` for output. No Charm libraries are currently used.

## Requirements

### Dependencies

Add Charm libraries to `go.mod`:

| Package                                | Purpose                              |
|----------------------------------------|--------------------------------------|
| `github.com/charmbracelet/bubbletea`   | TUI framework                        |
| `github.com/charmbracelet/bubbles`     | Reusable TUI components              |
| `github.com/charmbracelet/lipgloss`    | Terminal styling                     |
| `github.com/charmbracelet/log`         | Styled logging (replace fatih/color) |

### Commands

#### `tuna init`

- Animated spinner while creating directories
- Styled list of created/skipped items (color-coded)
- Success/info message with lipgloss styling

#### `tuna plan`

- Spinner during plan generation
- Styled summary box with plan details (ID, models, queries count)
- Warning styling for edge cases (no queries found)

#### `tuna exec`

- Real-time progress bar showing overall completion
- Per-model/per-query status table
- Live token counter
- Elapsed time display
- Error highlighting
- Final summary with styled statistics

### Architecture

Create `internal/tui/` package:

```
internal/tui/
├── styles.go      # Shared lipgloss styles
├── spinner.go     # Reusable spinner component
├── progress.go    # Progress bar component
├── table.go       # Status table component
└── exec/
    └── model.go   # bubbletea model for exec command
```

### Fallback

Preserve non-interactive mode for:
- Piped output (`!isatty`)
- CI environments (`CI=true`)
- Explicit flag (`--no-tui`)

## Acceptance criteria

- [ ] Charm libraries added to dependencies
- [ ] `internal/tui/` package with shared components
- [ ] `init` command uses styled output
- [ ] `plan` command uses styled output
- [ ] `exec` command shows real-time progress with bubbletea
- [ ] Non-interactive fallback works correctly
- [ ] Existing tests pass

---

## Implementation plan

### Step 1: Add dependencies

Add Charm libraries and TTY detection:

```bash
go get github.com/charmbracelet/bubbletea@latest
go get github.com/charmbracelet/bubbles@latest
go get github.com/charmbracelet/lipgloss@latest
go get github.com/charmbracelet/log@latest
go get github.com/mattn/go-isatty@latest
```

Remove `github.com/fatih/color` after migration.

**Files:**

| File     | Action |
|----------|--------|
| `go.mod` | Modify |
| `go.sum` | Modify |

### Step 2: Create TUI foundation

Create `internal/tui/` package with shared styles and TTY detection.

**Files:**

| File                    | Action |
|-------------------------|--------|
| `internal/tui/tui.go`   | Create |
| `internal/tui/styles.go`| Create |

`tui.go` — TTY detection and mode switching:

```go
package tui

func IsInteractive() bool // check isatty + CI env + --no-tui flag
func SetNonInteractive()  // force non-interactive mode
```

`styles.go` — shared lipgloss styles:

```go
package tui

var (
    Success  lipgloss.Style // green
    Warning  lipgloss.Style // yellow
    Error    lipgloss.Style // red
    Info     lipgloss.Style // blue
    Muted    lipgloss.Style // gray
    Bold     lipgloss.Style
    Title    lipgloss.Style
)
```

### Step 3: Implement reusable components

Create wrapper components over bubbles.

**Files:**

| File                      | Action |
|---------------------------|--------|
| `internal/tui/spinner.go` | Create |
| `internal/tui/progress.go`| Create |
| `internal/tui/list.go`    | Create |

`spinner.go` — spinner with message:

```go
func RunWithSpinner(message string, fn func() error) error
```

`progress.go` — progress bar wrapper:

```go
type Progress struct { ... }
func NewProgress(total int) *Progress
func (p *Progress) Increment()
func (p *Progress) View() string
```

`list.go` — styled list output:

```go
func RenderCreated(items []string) string
func RenderSkipped(items []string) string
func RenderErrors(items []string) string
```

### Step 4: Migrate `init` command

Replace plain output with styled components.

**Files:**

| File                          | Action |
|-------------------------------|--------|
| `internal/command/init.go`    | Modify |

Changes:
- Wrap `assistant.Init()` call with spinner
- Use `tui.RenderCreated()` / `tui.RenderSkipped()` for output
- Add non-interactive fallback (keep current behavior)

### Step 5: Migrate `plan` command

Replace plain output with styled components.

**Files:**

| File                          | Action |
|-------------------------------|--------|
| `internal/command/plan.go`    | Modify |

Changes:
- Wrap `plan.Generate()` call with spinner
- Use styled box for summary output
- Style warnings with `tui.Warning`
- Add non-interactive fallback

### Step 6: Create exec TUI model

This is the most complex part — full bubbletea integration for real-time progress.

**Files:**

| File                           | Action |
|--------------------------------|--------|
| `internal/tui/exec/model.go`   | Create |
| `internal/tui/exec/view.go`    | Create |
| `internal/tui/exec/update.go`  | Create |

Model state:

```go
type Model struct {
    progress    progress.Model
    table       table.Model
    totalTokens exec.TokenUsage
    elapsed     time.Duration
    results     []exec.Result
    errors      []error
    done        bool
}
```

Messages:

```go
type QueryStartMsg   struct { QueryID, Model string }
type QueryDoneMsg    struct { QueryID, Model string; Tokens exec.TokenUsage }
type QueryErrorMsg   struct { QueryID, Model string; Err error }
type ExecutionDoneMsg struct { Summary exec.Summary }
```

### Step 7: Integrate TUI into `exec` command

Connect bubbletea model with executor.

**Files:**

| File                          | Action |
|-------------------------------|--------|
| `internal/command/exec.go`    | Modify |
| `internal/exec/executor.go`   | Modify |

Changes in `executor.go`:
- Add callback/channel for progress events
- Emit events on query start/complete/error

Changes in `exec.go`:
- Run bubbletea program in interactive mode
- Keep current output for non-interactive mode

### Step 8: Add `--no-tui` flag

Add global flag to force non-interactive mode.

**Files:**

| File                          | Action |
|-------------------------------|--------|
| `internal/command/root.go`    | Modify |

Add persistent flag:

```go
rootCmd.PersistentFlags().Bool("no-tui", false, "Disable interactive TUI")
```

### Step 9: Cleanup and testing

- Remove `github.com/fatih/color` dependency
- Verify all existing tests pass
- Manual testing of all commands in TTY and non-TTY modes

**Files:**

| File     | Action |
|----------|--------|
| `go.mod` | Modify |

### Summary

| Step | Description                   | Complexity |
|------|-------------------------------|------------|
| 1    | Add dependencies              | Low        |
| 2    | Create TUI foundation         | Low        |
| 3    | Implement reusable components | Medium     |
| 4    | Migrate `init` command        | Low        |
| 5    | Migrate `plan` command        | Low        |
| 6    | Create exec TUI model         | High       |
| 7    | Integrate TUI into `exec`     | High       |
| 8    | Add `--no-tui` flag           | Low        |
| 9    | Cleanup and testing           | Low        |
